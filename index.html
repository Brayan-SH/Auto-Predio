<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auto Predio</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Bootstrap 5.3 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="container">
    <!-- Navbar fija que sigue el scroll -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top shadow">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">游뚱 Auto Predio</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#vehiculos">Cat치logo</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#favoritos">Favoritos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#comparar">Comparar Autos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#citas">Citas</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#contactos">Contactos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#agenda">Agenda</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#predios">Predios</a>
            </li>
          </ul>
          <form class="d-flex" role="search">
            <input
              class="form-control me-2"
              type="search"
              placeholder="Marca, modelo..."
              aria-label="Search"
              id="navbar-search"
            />
            <button class="btn btn-outline-success" type="button" onclick="buscarEnNavbar()">
              Buscar
            </button>
          </form>
        </div>
      </div>
    </nav>

    <!-- Contenedor principal con padding-top para compensar navbar fija -->
    <div class="container-fluid" style="padding-top: 80px;">
          <div class="container-fluid">
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="#"
                    >Cat치logo</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="#"
                    >Favoritos</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="#"
                    >Comparar Autos</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="#"
                    >Citas</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="#"
                    >Contactos</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="#"
                    >Agenda</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="#"
                    >Predios</a
                  >
                </li>
              </ul>
              <form class="d-flex" role="search">
                <input
                  class="form-control me-2"
                  type="search"
                  placeholder="Marca modelo..."
                  aria-label="Search"
                />
                <button
                  class="btn btn-outline-success"
                  onclick="cargarVehiculos()"
                >
                  Buscar
                </button>
              </form>
            </div>
          </div>
        </nav>
      </div>
    </div>
    
    <!-- Contenido principal -->
    <div class="container-fluid px-3">
        <!-- Secci칩n de Veh칤culos -->
      <div class="row mt-2">
        <div class="col-12">
          <!-- Header sticky de veh칤culos -->
          <div class="sticky-section-header d-flex justify-content-between align-items-center p-3 mb-0" style="background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(248,249,250,0.98) 100%); border-radius: 0.5rem 0.5rem 0 0;">
            <h5 class="mb-0 text-dark fw-bold">游뚲 Veh칤culos Disponibles</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-success btn-sm" onclick="cargarVehiculos()">Cargar</button>
            </div>
          </div>
          
          <!-- Contenido de veh칤culos -->
          <div class="card" style="border-top: none; border-radius: 0 0 0.5rem 0.5rem;">
            <div class="card-body" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); min-height: 60vh; padding-top: 1rem;">
              <div id="vehiculos-container">
                <!-- Los veh칤culos se cargar치n aqu칤 -->
              </div>
              <!-- Controles de paginaci칩n -->
              <div id="pagination-vehiculos" class="mt-3">
                <!-- Paginaci칩n se cargar치 aqu칤 -->
              </div>
            </div>
          </div>
        </div>
      </div>

      </div>
    </div>

    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Variables globales para paginaci칩n
      let currentPage = 1;
      let currentSearch = '';

      // Funci칩n para cargar veh칤culos con paginaci칩n
      function cargarVehiculos(page = 1) {
        const container = document.getElementById("vehiculos-container");
        const paginationContainer = document.getElementById("pagination-vehiculos");
        const searchInput = document.getElementById("search-vehiculos");
        
        currentPage = page;
        currentSearch = searchInput ? searchInput.value : '';
        
        container.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div>';
        paginationContainer.innerHTML = '';
        
        // Construir URL con par치metros
        let url = `http://localhost:5000/api/vehiculos?page=${page}&per_page=5`;
        if (currentSearch) {
          url += `&search=${encodeURIComponent(currentSearch)}`;
        }
        
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            let html = "";
            if (data.vehiculos.length === 0) {
              html = '<div class="alert alert-info">No hay veh칤culos encontrados</div>';
            } else {
              data.vehiculos.forEach((vehiculo) => {
                html += `
                  <div class="card mb-2">
                    <div class="card-body">
                      <h6 class="card-title">${vehiculo.marca} ${vehiculo.modelo}</h6>
                      <p class="card-text">
                        <small class="text-muted">A침o: ${vehiculo.anio_fabricacion}</small><br>
                        <small class="text-muted">Color: ${vehiculo.color}</small><br>
                        <small class="text-muted">Precio: ${vehiculo.precio}</small><br>
                        <small class="text-muted">Km: ${vehiculo.kilometraje}</small><br>
                        <span class="badge bg-info">${vehiculo.condicion}</span>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="verDetalle('${vehiculo.vin}')">Ver Detalle</button>
                      </p>
                    </div>
                  </div>
                `;
              });
            }
            container.innerHTML = html;
            
            // Crear controles de paginaci칩n
            if (data.pagination.total_pages > 1) {
              createPagination(data.pagination);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            container.innerHTML = '<div class="alert alert-danger">Error al cargar veh칤culos</div>';
          });
      }

      // Funci칩n para crear controles de paginaci칩n
      function createPagination(pagination) {
        const container = document.getElementById('pagination-vehiculos');
        let html = '<nav><ul class="pagination pagination-sm justify-content-center">';
        
        // Bot칩n anterior
        if (pagination.has_prev) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarVehiculos(${pagination.page - 1})">Anterior</a></li>`;
        } else {
          html += '<li class="page-item disabled"><span class="page-link">Anterior</span></li>';
        }
        
        // N칰meros de p치gina (m치ximo 5 p치ginas visibles)
        let startPage = Math.max(1, pagination.page - 2);
        let endPage = Math.min(pagination.total_pages, pagination.page + 2);
        
        for (let i = startPage; i <= endPage; i++) {
          if (i === pagination.page) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
          } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarVehiculos(${i})">${i}</a></li>`;
          }
        }
        
        // Bot칩n siguiente
        if (pagination.has_next) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarVehiculos(${pagination.page + 1})">Siguiente</a></li>`;
        } else {
          html += '<li class="page-item disabled"><span class="page-link">Siguiente</span></li>';
        }
        
        html += '</ul></nav>';
        html += `<small class="text-muted d-block text-center mt-2">Mostrando hasta ${pagination.per_page} de ${pagination.total} veh칤culos (P치gina ${pagination.page} de ${pagination.total_pages})</small>`;
        
        container.innerHTML = html;
      }

      // Funci칩n para ver detalle de un veh칤culo
      function verDetalle(vin) {
        fetch(`http://localhost:5000/api/vehiculos/${vin}`)
          .then(response => response.json())
          .then(vehiculo => {
            if (vehiculo.error) {
              alert('Veh칤culo no encontrado');
              return;
            }
            
            // Crear modal con detalles
            const modalHtml = `
              <div class="modal fade" id="detalleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">${vehiculo.marca} ${vehiculo.modelo} ${vehiculo.anio_fabricacion}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row">
                        <div class="col-md-6">
                          <p><strong>VIN:</strong> ${vehiculo.vin}</p>
                          <p><strong>Marca:</strong> ${vehiculo.marca}</p>
                          <p><strong>Modelo:</strong> ${vehiculo.modelo}</p>
                          <p><strong>A침o:</strong> ${vehiculo.anio_fabricacion}</p>
                          <p><strong>Color:</strong> ${vehiculo.color}</p>
                          <p><strong>Precio:</strong> ${vehiculo.precio}</p>
                        </div>
                        <div class="col-md-6">
                          <p><strong>Kilometraje:</strong> ${vehiculo.kilometraje} km</p>
                          <p><strong>Transmisi칩n:</strong> ${vehiculo.transmision}</p>
                          <p><strong>Combustible:</strong> ${vehiculo.tipo_combustible}</p>
                          <p><strong>Condici칩n:</strong> ${vehiculo.condicion}</p>
                          <p><strong>Contacto:</strong> ${vehiculo.contacto}</p>
                          <p><strong>Vendedor:</strong> ${vehiculo.predio_vendedor}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            // Agregar modal al DOM y mostrarlo
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('detalleModal'));
            modal.show();
            
            // Remover modal cuando se cierre
            document.getElementById('detalleModal').addEventListener('hidden.bs.modal', function() {
              this.remove();
            });
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar detalles del veh칤culo');
          });
      }

      // Cargar veh칤culos autom치ticamente al cargar la p치gina
      document.addEventListener("DOMContentLoaded", cargarVehiculos());
    </script>
    </div> <!-- Cierre del container principal -->
  </body>
</html>
